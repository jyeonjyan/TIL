# JPA N+1
> ê¸°ë³¸ê¸°ê°€ ì¤‘ìš”í•˜ê¸° ë•Œë¬¸ì— DataJPAê°€ ì•„ë‹Œ JPA (EntityManager)ì„ ì¨ì„œ ì—¬ëŸ¬ê°€ì§€ë¥¼ ì‹œí—˜ í•´ë³´ê³  ìˆë‹¤.  
> ê·¸ë¦¬ê³  ë‚˜ëŠ” N+1ì„ ê²½í—˜í•´ë³¸ì ì´ ì—†ë‹¤ ã…‹ã…‹ã…‹ã…‹

ìš°ì„  JPA N+1 ì„ ì´í•´í•˜ê¸° ì „ì— ì¦‰ì‹œë¡œë”©ê³¼ ì§€ì—°ë¡œë”©ì— ëŒ€í•´ ì•Œì•„ì•¼ í•œë‹¤.  
ì†”ì§íˆ ê·¸ëƒ¥ ì´ë¦„ë§Œ ë“¤ì–´ë„ ê°ì´ ì˜¤ì£ ?  

## ì¦‰ì‹œë¡œë”©(FetchType.EAGER), ì§€ì—°ë¡œë”©(FetchType.LAZY)

<img src="../../img/N+1-entity.png" width="400px">

ìœ„ì— ìˆëŠ” ì—”í‹°í‹° ë‹¤ì´ì–´ê·¸ë¨ì„ ë³´ë©´ Memberì™€ Teamì´ ì–‘ë°©í–¥ìœ¼ë¡œ N:1 ë¡œ ë¼ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.  

### ë‚˜ëŠ” ì¦‰ì‹œë¡œë”© í•˜ê³  ì‹¶ë‹¤.

ì¦‰ì‹œë¡œë”©ì€ ì–¸ì œ ì‚¬ìš©í•˜ë©´ ì¢‹ì€ ì „ëµì¼ê¹Œ?  
ê°„ë‹¨í•˜ë‹¤. ë‚˜ëŠ” ë¹„êµì  memberë¥¼ ì¡°íšŒí•  ë•Œ, teamë„ ê°€ì ¸ì™€ì•¼ ê°€ëŠ¥í•œ ë¹„ì¦ˆë‹ˆìŠ¤ë¡œì§ì„ ë§ì´ ì§ ë‹¤. í•˜ë©´ ì¦‰ì‹œë¡œë”©ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤.

```java
@Transactional
@Test @DisplayName("ì¦‰ì‹œë¡œë”©, ì§€ì—°ë¡œë”©")
void ì¦‰ì‹œë¡œë”©_ì§€ì—°ë¡œë”©(){
    Team team = Team.builder()
            .teamName("ì§€í™”ë‹ˆíŒ€")
            .build();

    entityManager.persist(team);

    Member member = Member.builder()
            .name("jihwan")
            .team(team)
            .build();

    entityManager.persist(member);

    // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì´ì „ ë‚´ìš© ë™ê¸°í™”
    entityManager.flush();
    // ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë‚´ìš© ë¹„ìš°ê¸°
    entityManager.clear();

    Member member1 = entityManager.find(Member.class, member.getId());
}
```

ì•„ë˜ëŠ” ìœ„ì— ì½”ë“œë¥¼ ì‹¤í–‰ì‹œí‚¨ í›„ ë°œìƒí•œ ì¿¼ë¦¬ë¬¸ì´ë‹¤.  
**`Member` ì—”í‹°í‹° `Team`ê³¼ì˜ FetchTypeì„ EAGER í–ˆì„ ë•Œì˜ ê²°ê³¼ì´ë‹¤.**

```sql
Hibernate: 
    select
        member0_.member_id as member_i1_0_0_,
        member0_.member_age as member_a2_0_0_,
        member0_.member_name as member_n3_0_0_,
        member0_.team_id as team_id4_0_0_,
        team1_.team_id as team_id1_1_1_,
        team1_.team_name as team_nam2_1_1_ 
    from
        member member0_ 
    left outer join
        team team1_ 
            on member0_.team_id=team1_.team_id 
    where
        member0_.member_id=?
```

`left outer join`ìœ¼ë¡œ memberì˜ ì—”í‹°í‹°ì— í•´ë‹¹í•œ íŒ€ì„ **ì¦‰ì‹œë¡œë”©** í•œë‹¤.  

- ì¥ì 
ë„¤íŠ¸ì›Œí¬ 1ë²ˆì— `member`ì™€ `team`ì„ ì¡°íšŒí•˜ëŠ” í•œë°©ì¿¼ë¦¬ë¥¼ í•œë‹¤ëŠ” ê²ƒì´ ì¥ì ì´ë‹¤. (ë§¤ë²ˆ memberì™€ teamì„ ê°™ì´ ì¡°íšŒí•œë‹¤ê³  í•˜ë©´)

- ë‹¨ì 
ì´ë ‡ê²Œ ì¡°ì¸ì„ 2, 3 í…Œì´ë¸”ë§Œ í•œë‹¤ë©´ ê·¸ ìì²´ê°€ ì„±ëŠ¥ìƒì— ì¹˜ëª…ì ì¸ ë¬¸ì œëŠ” ì•¼ê¸°ì‹œí‚¤ì§€ ì•Šì§€ë§Œ, ìš”ì²­ íšŸìˆ˜ì— ë”°ë¥¸ ë°˜í™˜ì‹œê°„ì€ ê±°ì˜ ë°°ê°€ ëœë‹¤ê³  ë³´ë©´ ëœë‹¤.  
ë˜í•œ ì—°ê´€(ì¡°ì¸) í…Œì´ë¸”ì´ ì¦ê°€í•˜ë©´ ì¦ê°€í•  ìˆ˜ë¡œ ë°˜í™˜ì‹œê°„ì€ ê¸¸ì–´ì§ˆ ê²ƒì´ë‹¤.

### ë‚˜ëŠ” ì§€ì—°ë¡œë”© í•˜ê³  ì‹¶ë‹¤!

ë‚˜ëŠ” memberë¥¼ ì¡°íšŒí•  ë•Œ ë”±íˆ teamì´ í•„ìš”í•  ë•Œê°€ ë³„ë¡œ ì—†ë‹¤.  
ê·¸ëŸ¼ ë§¤ë²ˆ team ì´ memberì™€ ì—°ê´€ì´ ìˆë‹¤ê³  select queryë¥¼ ë‚ ë¦¬ë©´ ì¢‹ì€ê±¸ê¹Œ? (ë‹µì€ ì•„ë‹ˆë‹¤. ê·¸ëƒ¥ memberë§Œ ì¡°íšŒí•˜ë©´ ëœë‹¤.)  

???? ğŸ˜§ ê·¸ê±¸ ì–´ë–»ê²Œ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆê¹Œ?? JPAëŠ” proxy ì—”í‹°í‹°ë¼ëŠ” ê¸°ìˆ ë¡œ ì´ ë¬¸ì œë¥¼ í•œë°©ì— í•´ê²°í•œë‹¤.  

ìŒ í”„ë¡ì‹œ ìì²´ì˜ ëœ»ì€ 'ëŒ€ë¦¬' ë¼ëŠ” ì˜ë¯¸ë¥¼ ê°€ì§„ë‹¤. JPAì—ì„œëŠ” ê°€ì§œ ì—”í‹°í‹°(?)ë¥¼ ë°˜í™˜í•˜ëŠ” ê¸°ìˆ  ì •ë„ë¡œ ì´í•´í•˜ë©´ ë  ê²ƒ ê°™ë‹¤.  
ë°©ë²•ì€ ê°„ë‹¨í•˜ë‹¤ ì—°ê´€ê´€ê³„ê°€ ìˆëŠ” ì¡°ì¸ ì¹¼ëŸ¼ì— `fetch = FetchType.LAZY` í•´ì£¼ë©´ ëœë‹¤.

```sql
Hibernate: 
    select
        member0_.member_id as member_i1_0_0_,
        member0_.member_age as member_a2_0_0_,
        member0_.member_name as member_n3_0_0_,
        member0_.team_id as team_id4_0_0_ 
    from
        member member0_ 
    where
        member0_.member_id=?
```

`fetch = FetchType.LAZY` ì„ ì ìš©ì‹œí‚¤ê³  ì•„ê¹Œ í…ŒìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ëŒë¦° ê²ƒì´ë‹¤.  
`member` ë§Œ ì¡°íšŒ ë˜ëŠ” ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ¼ ì•„ê¹Œ ë§í•œ proxy ì—”í‹°í‹°ëŠ” ì–´ë–»ê²Œ ì•Œ ìˆ˜ ìˆë‚˜..?

ì¡°íšŒëœ memberì˜ teamì— ì ‘ê·¼í•´ì„œ í´ë˜ìŠ¤ ì •ë³´ë¥¼ ë³´ë©´ `log.info(String.valueOf(member1.getTeam().getClass()));`  
`class com.jpa.just.model.Team$HibernateProxy$0alAnsnB` ì´ë ‡ê²Œ í•˜ì´ë²„ë„¤ì´íŠ¸ ì–´ì©Œê³  proxy ì—”í‹°í‹°ê°€ ë°˜í™˜ë˜ëŠ”ê±¸ ë³¼ ìˆ˜ ìˆë‹¤.

ì•„ë˜ ì²˜ëŸ¼ ì‹¤ì œë¡œ íŒ€ ë‚´ë¶€ì˜ í•„ë“œì— ì ‘ê·¼í•  ë•Œ teamì„ select í•œë‹¤.  
`team`ì„ ì–´ë–»ê²Œ select í•  ìˆ˜ ìˆëƒë©´, proxy ì—”í‹°í‹°ê°€ DBì—ê²Œ ì´ˆê¸°í™” ìš”ì²­ì„ í•´ì„œ select ê°€ ê°€ëŠ¥í•´ì§„ë‹¤.

```java
log.info("===========ì‹¤ì œë¡œ íŒ€ ì¡°íšŒë¥¼ ì‹œë„í•  ë•Œ=============");
String teamName = findMember.getTeam().getTeamName();
log.info("============teamName: {}=========", teamName);
```

```sql
2021-12-16 20:31:52.418  INFO 13845 --- [           main] com.jpa.just.model.MemberTest            : ===========ì‹¤ì œë¡œ íŒ€ ì¡°íšŒë¥¼ ì‹œë„í•  ë•Œ=============
Hibernate: 
    select
        team0_.team_id as team_id1_1_0_,
        team0_.team_name as team_nam2_1_0_ 
    from
        team team0_ 
    where
        team0_.team_id=?

```

